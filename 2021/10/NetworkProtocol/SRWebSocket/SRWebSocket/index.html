<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>SRWebSocket 源码解析 | vhuichen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="初始化流程- (id)initWithURLRequest:(NSURLRequest *)request protocols:(NSArray *)protocols allowsUntrustedSSLCertificates:(BOOL)allowsUntrustedSSLCertificates;初始化入口 - (void)_SR_commonInit;队列之类的数据初始化。这里要说的是，">
<meta property="og:type" content="article">
<meta property="og:title" content="SRWebSocket 源码解析">
<meta property="og:url" content="https://vhuichen.github.io/2021/10/NetworkProtocol/SRWebSocket/SRWebSocket/index.html">
<meta property="og:site_name" content="vhuichen">
<meta property="og:description" content="初始化流程- (id)initWithURLRequest:(NSURLRequest *)request protocols:(NSArray *)protocols allowsUntrustedSSLCertificates:(BOOL)allowsUntrustedSSLCertificates;初始化入口 - (void)_SR_commonInit;队列之类的数据初始化。这里要说的是，">
<meta property="og:locale">
<meta property="article:published_time" content="2021-10-12T16:00:00.000Z">
<meta property="article:modified_time" content="2021-10-23T16:00:00.000Z">
<meta property="article:author" content="vhuichen">
<meta property="article:tag" content="WebSocket">
<meta property="article:tag" content="SRWebSocket">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="vhuichen" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">vhuichen</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">记录、分享</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://vhuichen.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-NetworkProtocol/SRWebSocket/SRWebSocket" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/NetworkProtocol/SRWebSocket/SRWebSocket/" class="article-date">
  <time class="dt-published" datetime="2021-10-12T16:00:00.000Z" itemprop="datePublished">2021-10-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/">网络协议</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      SRWebSocket 源码解析
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="初始化流程"><a href="#初始化流程" class="headerlink" title="初始化流程"></a>初始化流程</h3><h5 id="id-initWithURLRequest-NSURLRequest-request-protocols-NSArray-protocols-allowsUntrustedSSLCertificates-BOOL-allowsUntrustedSSLCertificates"><a href="#id-initWithURLRequest-NSURLRequest-request-protocols-NSArray-protocols-allowsUntrustedSSLCertificates-BOOL-allowsUntrustedSSLCertificates" class="headerlink" title="- (id)initWithURLRequest:(NSURLRequest *)request protocols:(NSArray *)protocols allowsUntrustedSSLCertificates:(BOOL)allowsUntrustedSSLCertificates;"></a>- (id)initWithURLRequest:(NSURLRequest *)request protocols:(NSArray *)protocols allowsUntrustedSSLCertificates:(BOOL)allowsUntrustedSSLCertificates;</h5><p>初始化入口</p>
<h5 id="void-SR-commonInit"><a href="#void-SR-commonInit" class="headerlink" title="- (void)_SR_commonInit;"></a>- (void)_SR_commonInit;</h5><p>队列之类的数据初始化。<br>这里要说的是，SRWebSocket 内部创建一个常驻线程，用来接收数据流，还有一个专门用来处理业务的队列；当没有数据传输时常驻线程会进入休眠，此时队列任务发现<code>_readBuffer</code>没有数据，也会跳出循环等待，这样没有数据时也就不需要消耗多少资源了。</p>
<h5 id="void-initializeStreams"><a href="#void-initializeStreams" class="headerlink" title="- (void)_initializeStreams;"></a>- (void)_initializeStreams;</h5><p>初始化输入输出流</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">- (void)_initializeStreams &#123;</span><br><span class="line">    uint32_t port = _url.port.unsignedIntValue;</span><br><span class="line">    if (port == 0) &#123;</span><br><span class="line">        if (!_secure) &#123;</span><br><span class="line">            port = 80;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            port = 443;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    NSString *host = _url.host;</span><br><span class="line">    </span><br><span class="line">    CFReadStreamRef readStream = NULL;</span><br><span class="line">    CFWriteStreamRef writeStream = NULL;</span><br><span class="line">    //将 host port 与输入输出流绑定在一起</span><br><span class="line">    CFStreamCreatePairWithSocketToHost(NULL, (__bridge CFStringRef)host, port, &amp;readStream, &amp;writeStream);</span><br><span class="line">    </span><br><span class="line">    _outputStream = CFBridgingRelease(writeStream);</span><br><span class="line">    _inputStream = CFBridgingRelease(readStream);</span><br><span class="line">    </span><br><span class="line">    _inputStream.delegate = self;</span><br><span class="line">    _outputStream.delegate = self;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="连接流程"><a href="#连接流程" class="headerlink" title="连接流程"></a>连接流程</h3><h5 id="void-open"><a href="#void-open" class="headerlink" title="- (void)open;"></a>- (void)open;</h5><p>连接入口</p>
<h5 id="void-openConnection"><a href="#void-openConnection" class="headerlink" title="- (void)openConnection;"></a>- (void)openConnection;</h5><ol>
<li>将输入输出流注册到常驻线程</li>
<li>开启输入输出流</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[_outputStream scheduleInRunLoop:aRunLoop forMode:mode];</span><br><span class="line">[_inputStream scheduleInRunLoop:aRunLoop forMode:mode];</span><br><span class="line">[_outputStream open];</span><br><span class="line">[_inputStream open];</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h5 id="void-stream-NSStream-aStream-handleEvent-NSStreamEvent-eventCode"><a href="#void-stream-NSStream-aStream-handleEvent-NSStreamEvent-eventCode" class="headerlink" title="- (void)stream:(NSStream *)aStream handleEvent:(NSStreamEvent)eventCode;"></a>- (void)stream:(NSStream *)aStream handleEvent:(NSStreamEvent)eventCode;</h5><p>打开流成功后的回调</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">- (void)stream:(NSStream *)aStream handleEvent:(NSStreamEvent)eventCode &#123;</span><br><span class="line">    __weak typeof(self) weakSelf = self;</span><br><span class="line">    //第一次进来没认证，则进入，认证一次</span><br><span class="line">    if (_secure &amp;&amp; !_pinnedCertFound &amp;&amp; (eventCode == NSStreamEventHasBytesAvailable || eventCode == NSStreamEventHasSpaceAvailable)) &#123;</span><br><span class="line">        NSArray *sslCerts = [_urlRequest SR_SSLPinnedCertificates];</span><br><span class="line">        if (sslCerts) &#123;</span><br><span class="line">            SecTrustRef secTrust = (__bridge SecTrustRef)[aStream propertyForKey:(__bridge id)kCFStreamPropertySSLPeerTrust];</span><br><span class="line">            if (secTrust) &#123;</span><br><span class="line">                NSInteger numCerts = SecTrustGetCertificateCount(secTrust);</span><br><span class="line">                for (NSInteger i = 0; i &lt; numCerts &amp;&amp; !_pinnedCertFound; i++) &#123;</span><br><span class="line">                    SecCertificateRef cert = SecTrustGetCertificateAtIndex(secTrust, i);</span><br><span class="line">                    NSData *certData = CFBridgingRelease(SecCertificateCopyData(cert));</span><br><span class="line">                    for (id ref in sslCerts) &#123;</span><br><span class="line">                        SecCertificateRef trustedCert = (__bridge SecCertificateRef)ref;</span><br><span class="line">                        NSData *trustedCertData = CFBridgingRelease(SecCertificateCopyData(trustedCert));</span><br><span class="line">                        if ([trustedCertData isEqualToData:certData]) &#123;</span><br><span class="line">                            _pinnedCertFound = YES;</span><br><span class="line">                            break;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            if (!_pinnedCertFound) &#123;</span><br><span class="line">                return;//异常</span><br><span class="line">            &#125; else if (aStream == _outputStream) &#123;</span><br><span class="line">                // 认证成功，如果是输出流，则认为流连接成功，开始HTTP连接</span><br><span class="line">                dispatch_async(_workQueue, ^&#123;</span><br><span class="line">                    [self didConnect];</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    dispatch_async(_workQueue, ^&#123;</span><br><span class="line">    		// 后面所有的流都在这里处理</span><br><span class="line">        [weakSelf safeHandleEvent:eventCode stream:aStream];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="void-didConnect"><a href="#void-didConnect" class="headerlink" title="- (void)didConnect;"></a>- (void)didConnect;</h5><p>websocket 连接请求</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">- (void)didConnect &#123;</span><br><span class="line">    CFHTTPMessageRef request = CFHTTPMessageCreateRequest(NULL, CFSTR(&quot;GET&quot;), (__bridge CFURLRef)_url, kCFHTTPVersion1_1);</span><br><span class="line">    </span><br><span class="line">    // Set host first so it defaults</span><br><span class="line">    CFHTTPMessageSetHeaderFieldValue(request, CFSTR(&quot;Host&quot;), (__bridge CFStringRef)(_url.port ? [NSString stringWithFormat:@&quot;%@:%@&quot;, _url.host, _url.port] : _url.host));</span><br><span class="line">        </span><br><span class="line">    NSMutableData *keyBytes = [[NSMutableData alloc] initWithLength:16];</span><br><span class="line">    SecRandomCopyBytes(kSecRandomDefault, keyBytes.length, keyBytes.mutableBytes);</span><br><span class="line">    </span><br><span class="line">    if ([keyBytes respondsToSelector:@selector(base64EncodedStringWithOptions:)]) &#123;</span><br><span class="line">        _secKey = [keyBytes base64EncodedStringWithOptions:0];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        _secKey = [keyBytes base64Encoding];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Apply cookies if any have been provided</span><br><span class="line">    NSDictionary * cookies = [NSHTTPCookie requestHeaderFieldsWithCookies:[self requestCookies]];</span><br><span class="line">    for (NSString * cookieKey in cookies) &#123;</span><br><span class="line">        NSString * cookieValue = [cookies objectForKey:cookieKey];</span><br><span class="line">        if ([cookieKey length] &amp;&amp; [cookieValue length]) &#123;</span><br><span class="line">            CFHTTPMessageSetHeaderFieldValue(request, (__bridge CFStringRef)cookieKey, (__bridge CFStringRef)cookieValue);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    // set header for http basic auth</span><br><span class="line">    if (_url.user.length &amp;&amp; _url.password.length) &#123;</span><br><span class="line">        NSData *userAndPassword = [[NSString stringWithFormat:@&quot;%@:%@&quot;, _url.user, _url.password] dataUsingEncoding:NSUTF8StringEncoding];</span><br><span class="line">        NSString *userAndPasswordBase64Encoded;</span><br><span class="line">        if ([keyBytes respondsToSelector:@selector(base64EncodedStringWithOptions:)]) &#123;</span><br><span class="line">            userAndPasswordBase64Encoded = [userAndPassword base64EncodedStringWithOptions:0];</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            userAndPasswordBase64Encoded = [userAndPassword base64Encoding];</span><br><span class="line">        &#125;</span><br><span class="line">        _basicAuthorizationString = [NSString stringWithFormat:@&quot;Basic %@&quot;, userAndPasswordBase64Encoded];</span><br><span class="line">        CFHTTPMessageSetHeaderFieldValue(request, CFSTR(&quot;Authorization&quot;), (__bridge CFStringRef)_basicAuthorizationString);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CFHTTPMessageSetHeaderFieldValue(request, CFSTR(&quot;Upgrade&quot;), CFSTR(&quot;websocket&quot;));</span><br><span class="line">    CFHTTPMessageSetHeaderFieldValue(request, CFSTR(&quot;Connection&quot;), CFSTR(&quot;Upgrade&quot;));</span><br><span class="line">    CFHTTPMessageSetHeaderFieldValue(request, CFSTR(&quot;Sec-WebSocket-Key&quot;), (__bridge CFStringRef)_secKey);</span><br><span class="line">    CFHTTPMessageSetHeaderFieldValue(request, CFSTR(&quot;Sec-WebSocket-Version&quot;), (__bridge CFStringRef)[NSString stringWithFormat:@&quot;%ld&quot;, (long)_webSocketVersion]);</span><br><span class="line">    </span><br><span class="line">    CFHTTPMessageSetHeaderFieldValue(request, CFSTR(&quot;Origin&quot;), (__bridge CFStringRef)_url.SR_origin);</span><br><span class="line">    </span><br><span class="line">    if (_requestedProtocols) &#123;</span><br><span class="line">        CFHTTPMessageSetHeaderFieldValue(request, CFSTR(&quot;Sec-WebSocket-Protocol&quot;), (__bridge CFStringRef)[_requestedProtocols componentsJoinedByString:@&quot;, &quot;]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [_urlRequest.allHTTPHeaderFields enumerateKeysAndObjectsUsingBlock:^(id key, id obj, BOOL *stop) &#123;</span><br><span class="line">        CFHTTPMessageSetHeaderFieldValue(request, (__bridge CFStringRef)key, (__bridge CFStringRef)obj);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    NSData *message = CFBridgingRelease(CFHTTPMessageCopySerializedMessage(request));</span><br><span class="line">    </span><br><span class="line">    CFRelease(request);</span><br><span class="line">		// 通过输入输出流发起连接</span><br><span class="line">    [self _writeData:message];</span><br><span class="line">    //读取 HTTP 响应头</span><br><span class="line">    [self _readHTTPHeader];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="void-readHTTPHeader"><a href="#void-readHTTPHeader" class="headerlink" title="- (void)_readHTTPHeader;"></a>- (void)_readHTTPHeader;</h5><p>循环读取HTTP头部数据，分隔符 <code>\r\n\r\n</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- (void)_readHTTPHeader &#123;</span><br><span class="line">    if (_receivedHTTPHeaders == NULL) &#123;</span><br><span class="line">        _receivedHTTPHeaders = CFHTTPMessageCreateEmpty(NULL, NO);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    [self _readUntilHeaderCompleteWithCallback:^(SRWebSocket *self,  NSData *data) &#123;</span><br><span class="line">        CFHTTPMessageAppendBytes(_receivedHTTPHeaders, (const UInt8 *)data.bytes, data.length);</span><br><span class="line">        if (CFHTTPMessageIsHeaderComplete(_receivedHTTPHeaders)) &#123;</span><br><span class="line">            //读取到头部</span><br><span class="line">            [self _HTTPHeadersDidFinish];</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            [self _readHTTPHeader];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="void-HTTPHeadersDidFinish"><a href="#void-HTTPHeadersDidFinish" class="headerlink" title="- (void)_HTTPHeadersDidFinish;"></a>- (void)_HTTPHeadersDidFinish;</h3><p>判断连接是否成功</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">- (void)_HTTPHeadersDidFinish &#123;</span><br><span class="line">    NSInteger responseCode = CFHTTPMessageGetResponseStatusCode(_receivedHTTPHeaders);</span><br><span class="line">    // key 校验</span><br><span class="line">    if(![self _checkHandshake:_receivedHTTPHeaders]) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    NSString *negotiatedProtocol = CFBridgingRelease(CFHTTPMessageCopyHeaderFieldValue(_receivedHTTPHeaders, CFSTR(&quot;Sec-WebSocket-Protocol&quot;)));</span><br><span class="line">    if (negotiatedProtocol) &#123;</span><br><span class="line">        // Make sure we requested the protocol</span><br><span class="line">        if ([_requestedProtocols indexOfObject:negotiatedProtocol] == NSNotFound) &#123;</span><br><span class="line">            //子协议校验</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        _protocol = negotiatedProtocol;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    self.readyState = SR_OPEN;</span><br><span class="line">    </span><br><span class="line">    if (!_didFail) &#123;</span><br><span class="line">    		// 连接成功了，开始接收数据</span><br><span class="line">        [self _readFrameNew];</span><br><span class="line">    &#125;</span><br><span class="line">		// 回调给引用层</span><br><span class="line">    [self _performDelegateBlock:^&#123;</span><br><span class="line">        if ([self.delegate respondsToSelector:@selector(webSocketDidOpen:)]) &#123;</span><br><span class="line">            [self.delegate webSocketDidOpen:self];</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="数据流接收流程"><a href="#数据流接收流程" class="headerlink" title="数据流接收流程"></a>数据流接收流程</h3><h5 id="void-safeHandleEvent-NSStreamEvent-eventCode-stream-NSStream-aStream"><a href="#void-safeHandleEvent-NSStreamEvent-eventCode-stream-NSStream-aStream" class="headerlink" title="- (void)safeHandleEvent:(NSStreamEvent)eventCode stream:(NSStream *)aStream"></a>- (void)safeHandleEvent:(NSStreamEvent)eventCode stream:(NSStream *)aStream</h5><p>这里会将输入流中的数据读取到<code>_readBuffer</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">- (void)safeHandleEvent:(NSStreamEvent)eventCode stream:(NSStream *)aStream &#123;</span><br><span class="line">  switch (eventCode) &#123;</span><br><span class="line">      case NSStreamEventOpenCompleted: &#123;</span><br><span class="line">          // didConnect fires after certificate verification if we&#x27;re using pinned certificates.</span><br><span class="line">          BOOL usingPinnedCerts = [[_urlRequest SR_SSLPinnedCertificates] count] &gt; 0;</span><br><span class="line">          if ((!_secure || !usingPinnedCerts) &amp;&amp; self.readyState == SR_CONNECTING &amp;&amp; aStream == _inputStream) &#123;</span><br><span class="line">              [self didConnect];</span><br><span class="line">          &#125;</span><br><span class="line">          [self _pumpWriting];</span><br><span class="line">          [self _pumpScanner];</span><br><span class="line">          break;</span><br><span class="line">      &#125;</span><br><span class="line">      case NSStreamEventErrorOccurred: &#123;</span><br><span class="line">          break;</span><br><span class="line">      &#125;</span><br><span class="line">      case NSStreamEventEndEncountered: &#123;</span><br><span class="line">          break;</span><br><span class="line">      &#125;</span><br><span class="line">			// 接收到数据</span><br><span class="line">      case NSStreamEventHasBytesAvailable: &#123;</span><br><span class="line">          const int bufferSize = 2048;</span><br><span class="line">          uint8_t buffer[bufferSize];</span><br><span class="line">          while (_inputStream.hasBytesAvailable) &#123;</span><br><span class="line">              NSInteger bytes_read = [_inputStream read:buffer maxLength:bufferSize];</span><br><span class="line">              if (bytes_read &gt; 0) &#123;</span><br><span class="line">                  [_readBuffer appendBytes:buffer length:bytes_read];</span><br><span class="line">              &#125; else if (bytes_read &lt; 0) &#123;</span><br><span class="line">                  [self _failWithError:_inputStream.streamError];</span><br><span class="line">              &#125;</span><br><span class="line">              if (bytes_read != bufferSize) &#123;</span><br><span class="line">                  break;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;;</span><br><span class="line">          [self _pumpScanner];//开始扫描</span><br><span class="line">          break;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      case NSStreamEventHasSpaceAvailable: &#123;</span><br><span class="line">      		// 写数据时，没有写完的数据这里会继续写</span><br><span class="line">          [self _pumpWriting];</span><br><span class="line">          break;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-(void)_pumpScanner &#123;</span><br><span class="line">    if (!_isPumping) &#123;</span><br><span class="line">        _isPumping = YES;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    // 循环读取消费者需要的数据,如果没有数据则返回NO</span><br><span class="line">    while ([self _innerPumpScanner]) &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    _isPumping = NO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="BOOL-innerPumpScanner"><a href="#BOOL-innerPumpScanner" class="headerlink" title="- (BOOL)_innerPumpScanner"></a>- (BOOL)_innerPumpScanner</h3><p>读取到消费者需要的数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)_innerPumpScanner &#123;</span><br><span class="line">	//如果消费者为空，则直接返回</span><br><span class="line">	//读到消费者需要的数据长度时，返回TRUE</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="数据读取流程"><a href="#数据读取流程" class="headerlink" title="数据读取流程"></a>数据读取流程</h3><h5 id="void-readFrameNew"><a href="#void-readFrameNew" class="headerlink" title="- (void)_readFrameNew;"></a>- (void)_readFrameNew;</h5><p>清空上一帧上一帧数据，随后调用 <code>_readFrameContinue</code></p>
<h4 id="void-readFrameContinue"><a href="#void-readFrameContinue" class="headerlink" title="- (void)_readFrameContinue;"></a>- (void)_readFrameContinue;</h4><ol>
<li>添加一个消费者</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//添加消费者，用一个指定的长度，是否读到当前帧</span><br><span class="line">- (void)_addConsumerWithDataLength:(size_t)dataLength callback:(data_callback)callback readToCurrentFrame:(BOOL)readToCurrentFrame unmaskBytes:(BOOL)unmaskBytes &#123;</span><br><span class="line">    //添加到消费者队列</span><br><span class="line">    [_consumers addObject:[_consumerPool consumerWithScanner:nil handler:callback bytesNeeded:dataLength readToCurrentFrame:readToCurrentFrame unmaskBytes:unmaskBytes]];</span><br><span class="line">    //扫描消费者所需要的字节数</span><br><span class="line">    [self _pumpScanner];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">- (void)_readFrameContinue &#123;</span><br><span class="line">		// 添加一个消费者</span><br><span class="line">    [self _addConsumerWithDataLength:2 callback:^(SRWebSocket *self, NSData *data) &#123;</span><br><span class="line">        __block frame_header header = &#123;0&#125;;</span><br><span class="line">        const uint8_t *headerBuffer = data.bytes;</span><br><span class="line">        uint8_t receivedOpcode = (SROpCodeMask &amp; headerBuffer[0]);</span><br><span class="line">        BOOL isControlFrame = (receivedOpcode == SROpCodePing || receivedOpcode == SROpCodePong || receivedOpcode == SROpCodeConnectionClose);</span><br><span class="line">        </span><br><span class="line">        header.opcode = receivedOpcode == 0 ? self-&gt;_currentFrameOpcode : receivedOpcode;</span><br><span class="line">        header.fin = !!(SRFinMask &amp; headerBuffer[0]);</span><br><span class="line">        header.masked = !!(SRMaskMask &amp; headerBuffer[1]);</span><br><span class="line">        header.payload_length = SRPayloadLenMask &amp; headerBuffer[1];</span><br><span class="line">        </span><br><span class="line">        headerBuffer = NULL;</span><br><span class="line">        size_t extra_bytes_needed = header.masked ? sizeof(_currentReadMaskKey) : 0;</span><br><span class="line">        if (header.payload_length == 126) &#123;</span><br><span class="line">            extra_bytes_needed += sizeof(uint16_t);</span><br><span class="line">        &#125; else if (header.payload_length == 127) &#123;</span><br><span class="line">            extra_bytes_needed += sizeof(uint64_t);</span><br><span class="line">        &#125;</span><br><span class="line">        if (extra_bytes_needed == 0) &#123;</span><br><span class="line">        		// 不需要读取扩展字段，则开始读取数据段</span><br><span class="line">            [self _handleFrameHeader:header curData:self-&gt;_currentFrameData];</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">        		// 读取扩展字段</span><br><span class="line">            [self _addConsumerWithDataLength:extra_bytes_needed callback:^(SRWebSocket *self, NSData *data) &#123;</span><br><span class="line">                size_t mapped_size = data.length;</span><br><span class="line">                const void *mapped_buffer = data.bytes;</span><br><span class="line">                size_t offset = 0;</span><br><span class="line">                if (header.payload_length == 126) &#123;</span><br><span class="line">                    uint16_t newLen = EndianU16_BtoN(*(uint16_t *)(mapped_buffer));</span><br><span class="line">                    header.payload_length = newLen;</span><br><span class="line">                    offset += sizeof(uint16_t);</span><br><span class="line">                &#125; else if (header.payload_length == 127) &#123;</span><br><span class="line">                    header.payload_length = EndianU64_BtoN(*(uint64_t *)(mapped_buffer));</span><br><span class="line">                    offset += sizeof(uint64_t);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                if (header.masked) &#123;</span><br><span class="line">                    memcpy(self-&gt;_currentReadMaskKey, ((uint8_t *)mapped_buffer) + offset, sizeof(self-&gt;_currentReadMaskKey));</span><br><span class="line">                &#125;</span><br><span class="line">                // 读取到扩展字段后，再读取 Data 数据</span><br><span class="line">                [self _handleFrameHeader:header curData:self-&gt;_currentFrameData];</span><br><span class="line">            &#125; readToCurrentFrame:NO unmaskBytes:NO];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; readToCurrentFrame:NO unmaskBytes:NO];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>读取帧的数据段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">- (void)_handleFrameHeader:(frame_header)frame_header curData:(NSData *)curData &#123;    </span><br><span class="line">    BOOL isControlFrame = (frame_header.opcode == SROpCodePing || frame_header.opcode == SROpCodePong || frame_header.opcode == SROpCodeConnectionClose);</span><br><span class="line">    </span><br><span class="line">    if (!isControlFrame) &#123;</span><br><span class="line">        _currentFrameOpcode = frame_header.opcode;</span><br><span class="line">        _currentFrameCount += 1;</span><br><span class="line">    &#125;</span><br><span class="line">    //如果数据长度为0</span><br><span class="line">    if (frame_header.payload_length == 0) &#123;</span><br><span class="line">        if (isControlFrame) &#123;</span><br><span class="line">        		// 数据读完，开始处理数据</span><br><span class="line">            [self _handleFrameWithData:curData opCode:frame_header.opcode];</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            if (frame_header.fin) &#123;</span><br><span class="line">            		// 数据读完，开始处理数据</span><br><span class="line">                [self _handleFrameWithData:_currentFrameData opCode:frame_header.opcode];</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // TODO add assert that opcode is not a control;</span><br><span class="line">                // 数据还没读完，据需读取数据</span><br><span class="line">                [self _readFrameContinue];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">    		// 读取数据，回调后的处理流程同上</span><br><span class="line">        [self _addConsumerWithDataLength:(size_t)frame_header.payload_length callback:^(SRWebSocket *self, NSData *newData) &#123;</span><br><span class="line">            if (isControlFrame) &#123;</span><br><span class="line">                [self _handleFrameWithData:newData opCode:frame_header.opcode];</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                if (frame_header.fin) &#123;</span><br><span class="line">                    [self _handleFrameWithData:self-&gt;_currentFrameData opCode:frame_header.opcode];</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    // TODO add assert that opcode is not a control;</span><br><span class="line">                    [self _readFrameContinue];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; readToCurrentFrame:!isControlFrame unmaskBytes:frame_header.masked];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>开始处理数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">- (void)_handleFrameWithData:(NSData *)frameData opCode:(NSInteger)opcode &#123;                </span><br><span class="line">    BOOL isControlFrame = (opcode == SROpCodePing || opcode == SROpCodePong || opcode == SROpCodeConnectionClose);</span><br><span class="line">    if (!isControlFrame) &#123;</span><br><span class="line">    		// 里面是异步读取数据帧，跟下面的区别就是，非数据帧，需要先清理数据才能继续读取</span><br><span class="line">        [self _readFrameNew];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        dispatch_async(_workQueue, ^&#123;</span><br><span class="line">        		// 数据帧不需要清理数据，直接读取</span><br><span class="line">            [self _readFrameContinue];</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    //frameData will be copied before passing to handlers</span><br><span class="line">    //otherwise there can be misbehaviours when value at the pointer is changed</span><br><span class="line">    // 开始处理数据，到这里整个接收流程也就走完了</span><br><span class="line">    switch (opcode) &#123;</span><br><span class="line">        case SROpCodeTextFrame: &#123;</span><br><span class="line">            if ([self.delegate respondsToSelector:@selector(webSocketShouldConvertTextFrameToString:)] &amp;&amp; ![self.delegate webSocketShouldConvertTextFrameToString:self]) &#123;</span><br><span class="line">                [self _handleMessage:[frameData copy]];</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                NSString *str = [[NSString alloc] initWithData:frameData encoding:NSUTF8StringEncoding];</span><br><span class="line">                if (str == nil &amp;&amp; frameData) &#123;</span><br><span class="line">                    [self closeWithCode:SRStatusCodeInvalidUTF8 reason:@&quot;Text frames must be valid UTF-8&quot;];</span><br><span class="line">                    dispatch_async(_workQueue, ^&#123;</span><br><span class="line">                        [self closeConnection];</span><br><span class="line">                    &#125;);</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">                [self _handleMessage:str];</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        case SROpCodeBinaryFrame:</span><br><span class="line">            [self _handleMessage:[frameData copy]];</span><br><span class="line">            break;</span><br><span class="line">        case SROpCodeConnectionClose:</span><br><span class="line">            [self handleCloseWithData:[frameData copy]];</span><br><span class="line">            break;</span><br><span class="line">        case SROpCodePing:</span><br><span class="line">            [self handlePing:[frameData copy]];</span><br><span class="line">            break;</span><br><span class="line">        case SROpCodePong:</span><br><span class="line">            [self handlePong:[frameData copy]];</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="发送数据流程"><a href="#发送数据流程" class="headerlink" title="发送数据流程"></a>发送数据流程</h3><ol>
<li><ul>
<li>(void)send:(id)data;</li>
</ul>
</li>
<li><ul>
<li>(void)_sendFrameWithOpcode:(SROpCode)opcode data:(id)data;</li>
</ul>
</li>
<li><ul>
<li>(void)_writeData:(NSData *)data;</li>
</ul>
</li>
<li><ul>
<li>(void)_pumpWriting; &#x2F;&#x2F; 开始写数据，数据量很大的话，单次写不完，会在流回调中继续写数据</li>
</ul>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- (void)_pumpWriting &#123;</span><br><span class="line">    NSUInteger dataLength = _outputBuffer.length;</span><br><span class="line">    if (dataLength - _outputBufferOffset &gt; 0 &amp;&amp; _outputStream.hasSpaceAvailable) &#123;</span><br><span class="line">        // 这里写数据不一定全部写完</span><br><span class="line">        NSInteger bytesWritten = [_outputStream write:_outputBuffer.bytes + _outputBufferOffset maxLength:dataLength - _outputBufferOffset];</span><br><span class="line">        if (bytesWritten == -1) &#123;</span><br><span class="line">             return;</span><br><span class="line">        &#125;</span><br><span class="line">        //表示已经写入的大小</span><br><span class="line">        _outputBufferOffset += bytesWritten;</span><br><span class="line">        //超过一定值，则重置</span><br><span class="line">        if (_outputBufferOffset &gt; 4096 &amp;&amp; _outputBufferOffset &gt; (_outputBuffer.length &gt;&gt; 1)) &#123;</span><br><span class="line">            //更新偏移量，重新生成新的buffer</span><br><span class="line">            _outputBuffer = [[NSMutableData alloc] initWithBytes:(char *)_outputBuffer.bytes + _outputBufferOffset length:_outputBuffer.length - _outputBufferOffset];</span><br><span class="line">            _outputBufferOffset = 0;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>两个线程，一个负责生产，一个负责消费，这种生产者-消费者模式运用的很巧妙。<br>NSMutableData 运用的很好，避免了频繁生成 NSMutableData 对象；</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://vhuichen.github.io/2021/10/NetworkProtocol/SRWebSocket/SRWebSocket/" data-id="cl7m9rssk000d8wzycbechyrx" data-title="SRWebSocket 源码解析" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SRWebSocket/" rel="tag">SRWebSocket</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/WebSocket/" rel="tag">WebSocket</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/01/NetworkProtocol/WebSocket/WebSocket/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          WebSocket
        
      </div>
    </a>
  
  
    <a href="/2021/05/iOS/%E7%90%86%E8%A7%A3%20iOS%20%E4%B8%AD%E7%9A%84%20Modules/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">理解 iOS 中的 Modules</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/GitHub/">GitHub</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Markdown/">Markdown</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Swift/">Swift</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/Swift/">Swift</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS%E5%9F%BA%E7%A1%80/">iOS基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS%E5%BC%80%E5%8F%91/">iOS开发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/">网络协议</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%87%8D%E6%9E%84/">重构</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AES/" rel="tag">AES</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/APP%E9%BB%98%E8%AE%A4%E8%AF%AD%E8%A8%80/" rel="tag">APP默认语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Allocations/" rel="tag">Allocations</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Base64/" rel="tag">Base64</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Bugly/" rel="tag">Bugly</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CADisplayLink/" rel="tag">CADisplayLink</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CocoaPods/" rel="tag">CocoaPods</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cocoapods/" rel="tag">Cocoapods</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cookie/" rel="tag">Cookie</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cornerstone/" rel="tag">Cornerstone</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Designated-Initializer/" rel="tag">Designated Initializer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Effective-Objective-C-2-0/" rel="tag">Effective Objective-C 2.0</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FMDB/" rel="tag">FMDB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GCD/" rel="tag">GCD</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GitHub-Desktop/" rel="tag">GitHub Desktop</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/" rel="tag">HTTP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/" rel="tag">Hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Instruments/" rel="tag">Instruments</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/KCP/" rel="tag">KCP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MD5/" rel="tag">MD5</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MVC/" rel="tag">MVC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MVP/" rel="tag">MVP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MVVM/" rel="tag">MVVM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Markdown/" rel="tag">Markdown</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Module/" rel="tag">Module</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NSHTTPCookie/" rel="tag">NSHTTPCookie</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NSHTTPCookieStorage/" rel="tag">NSHTTPCookieStorage</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NSNumericSearch/" rel="tag">NSNumericSearch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NSOperation/" rel="tag">NSOperation</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NSPredicate/" rel="tag">NSPredicate</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NSString/" rel="tag">NSString</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NSThread/" rel="tag">NSThread</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NSTimeZone/" rel="tag">NSTimeZone</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NavigationItem/" rel="tag">NavigationItem</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Profile/" rel="tag">Profile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Push-Notification/" rel="tag">Push Notification</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SRWebSocket/" rel="tag">SRWebSocket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SVN/" rel="tag">SVN</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Singleton/" rel="tag">Singleton</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Socket/" rel="tag">Socket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swift/" rel="tag">Swift</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swift%E6%B7%B7%E7%BC%96/" rel="tag">Swift混编</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TCP/" rel="tag">TCP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UIImage/" rel="tag">UIImage</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UINavigationBar/" rel="tag">UINavigationBar</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UITableViewCell/" rel="tag">UITableViewCell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UITextField/" rel="tag">UITextField</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/URL-Schemes/" rel="tag">URL Schemes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/View/" rel="tag">View</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebSocket/" rel="tag">WebSocket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Workspace/" rel="tag">Workspace</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/anchorPoint/" rel="tag">anchorPoint</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hash/" rel="tag">hash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/initialize/" rel="tag">initialize</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/isEqual/" rel="tag">isEqual</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/libffi/" rel="tag">libffi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/load/" rel="tag">load</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BD%93%E7%A7%AF%E5%8C%85%E4%BC%98%E5%8C%96/" rel="tag">体积包优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%85%B3%E8%81%94%E5%AF%B9%E8%B1%A1/" rel="tag">关联对象</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" rel="tag">内存管理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%88%87%E6%8D%A2%E6%A0%B9%E6%8E%A7%E5%88%B6%E5%99%A8/" rel="tag">切换根控制器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8A%A0%E5%AF%86%E8%A7%A3%E5%AF%86/" rel="tag">加密解密</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8D%95%E4%BE%8B/" rel="tag">单例</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/" rel="tag">单元测试</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9C%B0%E5%9B%BE/" rel="tag">地图</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="tag">多线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B0%BE%E8%B0%83%E7%94%A8%E4%BC%98%E5%8C%96/" rel="tag">尾调用优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%8E%BB%E9%87%8D/" rel="tag">数据去重</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6/" rel="tag">时间复杂度</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A1%86%E6%9E%B6/" rel="tag">框架</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B6%88%E6%81%AF%E8%BD%AC%E5%8F%91/" rel="tag">消息转发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%83%AD%E6%9B%B4%E6%96%B0/" rel="tag">热更新</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AC%A6%E5%8F%B7%E8%A1%A8/" rel="tag">符号表</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AC%AC%E4%B8%89%E6%96%B9%E7%99%BB%E5%BD%95/" rel="tag">第三方登录</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%B1%BB%E5%AF%B9%E8%B1%A1%E6%9C%AC%E8%B4%A8/" rel="tag">类对象本质</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%B1%BB%E6%97%8F%E6%A8%A1%E5%BC%8F/" rel="tag">类族模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%A6%E6%9D%9F/" rel="tag">约束</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E7%A8%8B/" rel="tag">线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E8%AF%91%E6%97%B6/" rel="tag">编译时</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%87%AA%E5%8A%A8%E7%99%BB%E5%BD%95/" rel="tag">自动登录</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%87%AA%E5%8A%A8%E9%87%8A%E6%94%BE%E6%B1%A0/" rel="tag">自动释放池</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BF%90%E8%A1%8C%E6%97%B6/" rel="tag">运行时</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BF%9B%E7%A8%8B/" rel="tag">进程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%87%8D%E6%9E%84/" rel="tag">重构</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/AES/" style="font-size: 10px;">AES</a> <a href="/tags/APP%E9%BB%98%E8%AE%A4%E8%AF%AD%E8%A8%80/" style="font-size: 10px;">APP默认语言</a> <a href="/tags/Allocations/" style="font-size: 10px;">Allocations</a> <a href="/tags/Base64/" style="font-size: 10px;">Base64</a> <a href="/tags/Bugly/" style="font-size: 10px;">Bugly</a> <a href="/tags/CADisplayLink/" style="font-size: 10px;">CADisplayLink</a> <a href="/tags/CocoaPods/" style="font-size: 13.33px;">CocoaPods</a> <a href="/tags/Cocoapods/" style="font-size: 10px;">Cocoapods</a> <a href="/tags/Cookie/" style="font-size: 10px;">Cookie</a> <a href="/tags/Cornerstone/" style="font-size: 10px;">Cornerstone</a> <a href="/tags/Designated-Initializer/" style="font-size: 10px;">Designated Initializer</a> <a href="/tags/Effective-Objective-C-2-0/" style="font-size: 20px;">Effective Objective-C 2.0</a> <a href="/tags/FMDB/" style="font-size: 10px;">FMDB</a> <a href="/tags/GCD/" style="font-size: 13.33px;">GCD</a> <a href="/tags/GitHub-Desktop/" style="font-size: 10px;">GitHub Desktop</a> <a href="/tags/HTTP/" style="font-size: 10px;">HTTP</a> <a href="/tags/Hexo/" style="font-size: 13.33px;">Hexo</a> <a href="/tags/Instruments/" style="font-size: 10px;">Instruments</a> <a href="/tags/KCP/" style="font-size: 10px;">KCP</a> <a href="/tags/MD5/" style="font-size: 10px;">MD5</a> <a href="/tags/MVC/" style="font-size: 10px;">MVC</a> <a href="/tags/MVP/" style="font-size: 10px;">MVP</a> <a href="/tags/MVVM/" style="font-size: 10px;">MVVM</a> <a href="/tags/Markdown/" style="font-size: 10px;">Markdown</a> <a href="/tags/Module/" style="font-size: 10px;">Module</a> <a href="/tags/NSHTTPCookie/" style="font-size: 10px;">NSHTTPCookie</a> <a href="/tags/NSHTTPCookieStorage/" style="font-size: 10px;">NSHTTPCookieStorage</a> <a href="/tags/NSNumericSearch/" style="font-size: 10px;">NSNumericSearch</a> <a href="/tags/NSOperation/" style="font-size: 10px;">NSOperation</a> <a href="/tags/NSPredicate/" style="font-size: 10px;">NSPredicate</a> <a href="/tags/NSString/" style="font-size: 10px;">NSString</a> <a href="/tags/NSThread/" style="font-size: 10px;">NSThread</a> <a href="/tags/NSTimeZone/" style="font-size: 10px;">NSTimeZone</a> <a href="/tags/NavigationItem/" style="font-size: 10px;">NavigationItem</a> <a href="/tags/Profile/" style="font-size: 10px;">Profile</a> <a href="/tags/Push-Notification/" style="font-size: 10px;">Push Notification</a> <a href="/tags/SRWebSocket/" style="font-size: 10px;">SRWebSocket</a> <a href="/tags/SVN/" style="font-size: 16.67px;">SVN</a> <a href="/tags/Singleton/" style="font-size: 10px;">Singleton</a> <a href="/tags/Socket/" style="font-size: 10px;">Socket</a> <a href="/tags/Swift/" style="font-size: 13.33px;">Swift</a> <a href="/tags/Swift%E6%B7%B7%E7%BC%96/" style="font-size: 10px;">Swift混编</a> <a href="/tags/TCP/" style="font-size: 10px;">TCP</a> <a href="/tags/UIImage/" style="font-size: 10px;">UIImage</a> <a href="/tags/UINavigationBar/" style="font-size: 10px;">UINavigationBar</a> <a href="/tags/UITableViewCell/" style="font-size: 10px;">UITableViewCell</a> <a href="/tags/UITextField/" style="font-size: 10px;">UITextField</a> <a href="/tags/URL-Schemes/" style="font-size: 10px;">URL Schemes</a> <a href="/tags/View/" style="font-size: 10px;">View</a> <a href="/tags/WebSocket/" style="font-size: 16.67px;">WebSocket</a> <a href="/tags/Workspace/" style="font-size: 10px;">Workspace</a> <a href="/tags/anchorPoint/" style="font-size: 10px;">anchorPoint</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/hash/" style="font-size: 10px;">hash</a> <a href="/tags/initialize/" style="font-size: 10px;">initialize</a> <a href="/tags/isEqual/" style="font-size: 10px;">isEqual</a> <a href="/tags/libffi/" style="font-size: 10px;">libffi</a> <a href="/tags/load/" style="font-size: 10px;">load</a> <a href="/tags/%E4%BD%93%E7%A7%AF%E5%8C%85%E4%BC%98%E5%8C%96/" style="font-size: 10px;">体积包优化</a> <a href="/tags/%E5%85%B3%E8%81%94%E5%AF%B9%E8%B1%A1/" style="font-size: 10px;">关联对象</a> <a href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" style="font-size: 10px;">内存管理</a> <a href="/tags/%E5%88%87%E6%8D%A2%E6%A0%B9%E6%8E%A7%E5%88%B6%E5%99%A8/" style="font-size: 10px;">切换根控制器</a> <a href="/tags/%E5%8A%A0%E5%AF%86%E8%A7%A3%E5%AF%86/" style="font-size: 10px;">加密解密</a> <a href="/tags/%E5%8D%95%E4%BE%8B/" style="font-size: 10px;">单例</a> <a href="/tags/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/" style="font-size: 10px;">单元测试</a> <a href="/tags/%E5%9C%B0%E5%9B%BE/" style="font-size: 10px;">地图</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 10px;">多线程</a> <a href="/tags/%E5%B0%BE%E8%B0%83%E7%94%A8%E4%BC%98%E5%8C%96/" style="font-size: 10px;">尾调用优化</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%8E%BB%E9%87%8D/" style="font-size: 10px;">数据去重</a> <a href="/tags/%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6/" style="font-size: 10px;">时间复杂度</a> <a href="/tags/%E6%A1%86%E6%9E%B6/" style="font-size: 10px;">框架</a> <a href="/tags/%E6%B6%88%E6%81%AF%E8%BD%AC%E5%8F%91/" style="font-size: 10px;">消息转发</a> <a href="/tags/%E7%83%AD%E6%9B%B4%E6%96%B0/" style="font-size: 10px;">热更新</a> <a href="/tags/%E7%AC%A6%E5%8F%B7%E8%A1%A8/" style="font-size: 10px;">符号表</a> <a href="/tags/%E7%AC%AC%E4%B8%89%E6%96%B9%E7%99%BB%E5%BD%95/" style="font-size: 10px;">第三方登录</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 10px;">算法</a> <a href="/tags/%E7%B1%BB%E5%AF%B9%E8%B1%A1%E6%9C%AC%E8%B4%A8/" style="font-size: 10px;">类对象本质</a> <a href="/tags/%E7%B1%BB%E6%97%8F%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;">类族模式</a> <a href="/tags/%E7%BA%A6%E6%9D%9F/" style="font-size: 10px;">约束</a> <a href="/tags/%E7%BA%BF%E7%A8%8B/" style="font-size: 10px;">线程</a> <a href="/tags/%E7%BC%96%E8%AF%91%E6%97%B6/" style="font-size: 10px;">编译时</a> <a href="/tags/%E8%87%AA%E5%8A%A8%E7%99%BB%E5%BD%95/" style="font-size: 10px;">自动登录</a> <a href="/tags/%E8%87%AA%E5%8A%A8%E9%87%8A%E6%94%BE%E6%B1%A0/" style="font-size: 10px;">自动释放池</a> <a href="/tags/%E8%BF%90%E8%A1%8C%E6%97%B6/" style="font-size: 10px;">运行时</a> <a href="/tags/%E8%BF%9B%E7%A8%8B/" style="font-size: 10px;">进程</a> <a href="/tags/%E9%87%8D%E6%9E%84/" style="font-size: 10px;">重构</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/05/NetworkProtocol/KCP/KCP/">KCP 协议</a>
          </li>
        
          <li>
            <a href="/2022/04/iOS/libffi%E6%8E%A2%E7%A9%B6%20/">libffi 探究</a>
          </li>
        
          <li>
            <a href="/2022/03/iOS/iOS%E5%AF%B9%E8%B1%A1%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E5%8A%A0%E5%85%A5%E8%87%AA%E5%8A%A8%E9%87%8A%E6%94%BE%E6%B1%A0/">ARC下，对象什么时候加入自动释放池</a>
          </li>
        
          <li>
            <a href="/2022/01/NetworkProtocol/WebSocket/WebSocket/">WebSocket</a>
          </li>
        
          <li>
            <a href="/2021/10/NetworkProtocol/SRWebSocket/SRWebSocket/">SRWebSocket 源码解析</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 vhuichen<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>